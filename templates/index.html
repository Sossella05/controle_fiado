<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Fiado - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">ğŸ’° Controle de Fiado</a>
      <div class="d-flex">
        <span class="navbar-text text-white me-3">UsuÃ¡rio: {{ usuario }}</span>
        <a href="/backup" class="btn btn-success btn-sm me-2">ğŸ’¾ Backup</a>
        <a href="/logout" class="btn btn-outline-light btn-sm">Sair</a>
      </div>
    </div>
  </nav>

  <div class="container">

    <!-- TABELA DE CLIENTES -->
    <div class="card shadow-sm mb-5">
      <div class="card-body">
        <h4 class="card-title mb-4">ğŸ“‹ Resumo de Clientes</h4>

        <table class="table table-hover align-middle">
          <thead class="table-dark text-center">
            <tr>
              <th>Cliente</th>
              <th>Total Comprado</th>
              <th>Total Pago</th>
              <th>Saldo Devedor</th>
              <th>AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody>
            {% for id, nome, total_compra, total_pago, saldo in dados %}
            <tr class="text-center">
              <td>{{ nome }}</td>
              <td>R$ {{ "%.2f"|format(total_compra) }}</td>
              <td>R$ {{ "%.2f"|format(total_pago) }}</td>
              <td class="{{ 'text-danger' if saldo > 0 else 'text-success' }}">
                R$ {{ "%.2f"|format(saldo) }}
              </td>
              <td>
                <div class="d-flex flex-column align-items-center">
                  <a href="/cliente/{{ id }}" class="btn btn-sm btn-primary mb-1 w-75">ğŸ“œ HistÃ³rico</a>
                  <a href="/lancar/{{ id }}" class="btn btn-sm btn-success mb-1 w-75">â• LanÃ§ar</a>
                  <button class="btn btn-sm btn-warning mb-1 w-75" onclick="abrirPagamento({{ id }}, '{{ nome }}')">ğŸ’µ Pagamento</button>
                  <a href="/editar/{{ id }}" class="btn btn-sm btn-secondary mb-1 w-75">âœï¸ Editar</a>
                  <button class="btn btn-sm btn-danger w-75" onclick="confirmarExclusao({{ id }}, '{{ nome }}')">ğŸ—‘ï¸ Excluir</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <a href="/cliente" class="btn btn-success mt-3">â• Adicionar Cliente</a>
      </div>
    </div>

    <!-- GRÃFICOS -->
    <div class="row">
      <div class="col-md-6">
        <div class="card shadow-sm mb-4">
          <div class="card-body" style="height: 400px;">
            <h5 class="card-title">ğŸ“‰ Saldo Devedor por Cliente</h5>
            <canvas id="graficoSaldo" height="300"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm mb-4">
          <div class="card-body" style="height: 400px;">
            <h5 class="card-title">ğŸ’µ Total Comprado vs Pago</h5>
            <canvas id="graficoComparativo" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PAGAMENTO -->
  <div class="modal fade" id="modalPagamento" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="formPagamento" method="POST" action="">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">ğŸ’µ Atualizar Pagamento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p id="nomeCliente" class="fw-bold mb-3"></p>
            <div class="mb-3">
              <label for="valor_pago" class="form-label">Valor pago (R$)</label>
              <input type="number" class="form-control" id="valor_pago" name="valor_pago" step="0.01" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const nomes = {{ nomes | tojson }};
    const saldos = {{ saldos | tojson }};
    const totalCompras = {{ total_compras | tojson }};
    const totalPagos = {{ total_pagos | tojson }};

    // Modal de pagamento
    function abrirPagamento(clienteId, clienteNome) {
      const modal = new bootstrap.Modal(document.getElementById('modalPagamento'));
      const form = document.getElementById('formPagamento');
      const nome = document.getElementById('nomeCliente');
      nome.innerText = "Cliente: " + clienteNome;
      form.action = `/pagamento/${clienteId}`;
      modal.show();
    }

    // ConfirmaÃ§Ã£o antes de excluir
    function confirmarExclusao(clienteId, clienteNome) {
      if (confirm(`Tem certeza que deseja excluir o cliente "${clienteNome}"?`)) {
        window.location.href = `/excluir/${clienteId}`;
      }
    }

    // GrÃ¡fico de barras (Saldo)
    new Chart(document.getElementById("graficoSaldo"), {
      type: 'bar',
      data: {
        labels: nomes,
        datasets: [{
          label: 'Saldo Devedor (R$)',
          data: saldos,
          backgroundColor: saldos.map(s => s > 0 ? 'rgba(255,99,132,0.7)' : 'rgba(75,192,192,0.7)')
        }]
      },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    // GrÃ¡fico de pizza (Total Comprado x Pago)
    new Chart(document.getElementById("graficoComparativo"), {
      type: 'pie',
      data: {
        labels: ['Total Comprado', 'Total Pago'],
        datasets: [{
          data: [
            totalCompras.reduce((a,b)=>a+b,0),
            totalPagos.reduce((a,b)=>a+b,0)
          ],
          backgroundColor: ['rgba(255,206,86,0.7)', 'rgba(75,192,192,0.7)']
        }]
      },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  </script>

</body>
</html>
