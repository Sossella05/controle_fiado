{% extends "base.html" %}
{% block content %}
<h3 class="mb-4 fw-semibold">ğŸ“‹ Resumo de Clientes</h3>

<!-- Campo de pesquisa -->
<div class="input-group mb-4">
  <span class="input-group-text bg-white border-end-0">ğŸ”</span>
  <input type="text" id="pesquisaCliente" class="form-control border-start-0 search-input"
         placeholder="Buscar cliente por nome...">
</div>

<!-- BotÃ£o Desfazer -->
{% if session.get('ultima_acao') %}
  <form method="POST" action="/desfazer" class="mb-3">
    <button type="submit" class="btn btn-outline-danger btn-sm">â†©ï¸ Desfazer Ãºltima aÃ§Ã£o</button>
  </form>
{% endif %}

<!-- Tabela de clientes -->
<div class="card p-3 shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle text-center">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Total Comprado</th>
          <th>Total Pago</th>
          <th>Saldo Devedor</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody>
        {% for id, nome, total_compra, total_pago, saldo in dados %}
        <tr>
          <td>{{ nome }}</td>
          <td>R$ {{ "%.2f"|format(total_compra) }}</td>
          <td>R$ {{ "%.2f"|format(total_pago) }}</td>
          <td class="{{ 'text-danger fw-semibold' if saldo > 0 else 'text-success fw-semibold' }}">
            R$ {{ "%.2f"|format(saldo) }}
          </td>
          <td>
            <div class="d-flex justify-content-center flex-wrap gap-1">
              <a href="/lancar/{{ id }}" class="btn btn-success btn-sm">â• LanÃ§ar</a>
              <button class="btn btn-warning btn-sm text-dark" onclick="abrirPagamento({{ id }}, '{{ nome }}')">
                ğŸ’µ Pagamento
              </button>
              <button class="btn btn-danger btn-sm" onclick="confirmarExclusao({{ id }}, '{{ nome }}')">
                ğŸ—‘ï¸ Excluir
              </button>
              <a href="/cliente/{{ id }}" class="btn btn-primary btn-sm">ğŸ“œ HistÃ³rico</a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <a href="/cliente" class="btn btn-success mt-3">â• Adicionar Cliente</a>
</div>

<!-- GrÃ¡ficos -->
<div class="row mt-5">
  <div class="col-md-6 mb-4">
    <div class="card p-3 shadow-sm">
      <h5 class="mb-3 fw-semibold">ğŸ“‰ Saldo Devedor por Cliente</h5>
      <canvas id="graficoSaldo"></canvas>
    </div>
  </div>

  <div class="col-md-6 mb-4">
    <div class="card p-3 shadow-sm">
      <h5 class="mb-3 fw-semibold">ğŸ’° Total Comprado vs Pago</h5>
      <canvas id="graficoComparativo"></canvas>
    </div>
  </div>
</div>

<!-- Modal de Pagamento -->
<div class="modal fade" id="modalPagamento" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <form id="formPagamento" method="POST" action="">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title fw-semibold">ğŸ’µ Atualizar Pagamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="nomeCliente" class="fw-bold mb-3"></p>
          <div class="mb-3">
            <label for="valor_pago" class="form-label">Valor pago (R$)</label>
            <input type="number" class="form-control" id="valor_pago" name="valor_pago" step="0.01" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const nomes = {{ nomes | tojson }};
  const saldos = {{ saldos | tojson }};
  const totalCompras = {{ total_compras | tojson }};
  const totalPagos = {{ total_pagos | tojson }};

  // Pesquisa dinÃ¢mica
  document.getElementById("pesquisaCliente").addEventListener("keyup", function() {
    const termo = this.value.toLowerCase();
    const linhas = document.querySelectorAll("tbody tr");
    linhas.forEach(l => {
      const nome = l.children[0].innerText.toLowerCase();
      l.style.display = nome.includes(termo) ? "" : "none";
    });
  });

  // Modal pagamento
  function abrirPagamento(id, nome) {
    const modal = new bootstrap.Modal(document.getElementById('modalPagamento'));
    document.getElementById('formPagamento').action = `/pagamento/${id}`;
    document.getElementById('nomeCliente').innerText = "Cliente: " + nome;
    modal.show();
  }

  // Confirma exclusÃ£o
  function confirmarExclusao(id, nome) {
    if (confirm(`Tem certeza que deseja excluir o cliente "${nome}"?`)) {
      window.location.href = `/excluir/${id}`;
    }
  }

  // GrÃ¡fico de barras
  new Chart(document.getElementById("graficoSaldo"), {
    type: 'bar',
    data: {
      labels: nomes,
      datasets: [{
        label: 'Saldo Devedor (R$)',
        data: saldos,
        backgroundColor: saldos.map(s => s > 0 ? 'rgba(255,99,132,0.7)' : 'rgba(75,192,192,0.7)')
      }]
    },
    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  // GrÃ¡fico de pizza
  new Chart(document.getElementById("graficoComparativo"), {
    type: 'pie',
    data: {
      labels: ['Total Comprado', 'Total Pago'],
      datasets: [{
        data: [
          totalCompras.reduce((a,b)=>a+b,0),
          totalPagos.reduce((a,b)=>a+b,0)
        ],
        backgroundColor: ['rgba(255,206,86,0.7)', 'rgba(75,192,192,0.7)']
      }]
    },
    options: { plugins: { legend: { position: 'bottom' } } }
  });
</script>
{% endblock %}
